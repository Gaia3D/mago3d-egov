<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="EgovDataDAO">
	<typeAlias  alias="DataVO" type="egovframework.let.mago3d.service.DataVO"/>

	<!-- Data 총 건수 -->
	<select id="EgovDataDAO.selectDataTotalCount" parameterClass="DataVO" resultClass="long">
		/* selectDataTotalCount */
		SELECT COUNT(data_id) 
		FROM data_info
	</select>
	
	<!-- Data 목록 -->
	<select id="EgovDataDAO.selectListData" parameterClass="dataVO" resultClass="dataVO">
		/* selectListData */
		SELECT X.*, 
			(SELECT project_name FROM project WHERE project_id = X.project_id) AS project_name
		FROM (
			SELECT *
			FROM data_info
			OFFSET #offset# LIMIT #limit#
		) X
	</select>
		
<!-- 	<select id="EgovProjectDAO.selectProject" parameterClass="long" resultClass="project">
		/* selectProject */
		SELECT * FROM project WHERE project_id = #project_id# 
	</select> -->
	
<!-- 	<select id="EgovProjectDAO.selectDuplicationKeyCount" parameterClass="string" resultClass="int">
		/* selectDuplicationKeyCount */
		SELECT COUNT(project_key) AS count 
		FROM project
		WHERE project_key = #project_key#
	</select> -->
	
	<!-- Data 등록 -->
	<insert id="EgovDataDAO.insertData" parameterClass="dataVO">
		/* insertData */
		<selectKey keyProperty="data_id" resultClass="long" type="pre">
    		SELECT NEXTVAL('data_info_seq')
  		</selectKey>
		INSERT INTO data_info(
			data_id, project_id, data_key, data_name, parent, depth, view_order, 
			location, latitude, longitude, height, heading, pitch, roll, description
			<isNotNull property="mapping_type">
				<isNotEqual property="attributes" compareValue="">
					, mapping_type
				</isNotEqual>
			</isNotNull>
			<isNotNull property="attributes">
				<isNotEqual property="attributes" compareValue="">
					, attributes
				</isNotEqual>
			</isNotNull>
		) values(
			#data_id#, #project_id#, #data_key#, #data_name#, #parent#, #depth#, #view_order#, 
			ST_GeographyFromText(#location#), #latitude#, #longitude#, #height#, #heading#, #pitch#, #roll#, #description#
			<isNotNull property="mapping_type">
				<isNotEqual property="attributes" compareValue="">
					, #mapping_type#
				</isNotEqual>
			</isNotNull>
			<isNotNull property="attributes">
				<isNotEqual property="attributes" compareValue="">
					, TO_JSON(#attributes#::json)
				</isNotEqual>
			</isNotNull>
		)
	</insert>
	
	<!-- Data 수정 -->
	<update id="EgovDataDAO.updateData" parameterClass="dataVO">
		/* updateData */
		UPDATE data_info
		SET 
			<isNotNull property="project_id">
				<isNotEqual property="project_id" compareValue="0">
					project_id = #project_id#,
				</isNotEqual>
			</isNotNull>
			<isNotNull property="data_key">
				<isNotEqual property="data_key" compareValue="">
					data_key = #data_key#,
				</isNotEqual>
			</isNotNull>
			<isNotNull property="data_name">
				<isNotEqual property="data_name" compareValue="">
					data_name = #data_name#,
				</isNotEqual>
			</isNotNull>
			<isNotNull property="mapping_type">
				<isNotEqual property="mapping_type" compareValue="">
					mapping_type = #mapping_type#,
				</isNotEqual>
			</isNotNull>
			<isNotNull property="location">
					location = ST_GeographyFromText(#location#),
			</isNotNull>
			<isNotNull property="latitude">
					latitude = #latitude#,
			</isNotNull>
			<isNotNull property="longitude">
					longitude = #longitude#,
			</isNotNull>
			<isNotNull property="height">
					height = #height#,
			</isNotNull>
			<isNotNull property="heading">
					heading = #heading#,
			</isNotNull>
			<isNotNull property="pitch">
					pitch = #pitch#,
			</isNotNull>
			<isNotNull property="roll">
					roll = #roll#,
			</isNotNull>
			<isNotNull property="public_yn">
				<isNotEqual property="public_yn" compareValue="">
					public_yn = #public_yn#,
				</isNotEqual>
			</isNotNull>
			<isNotNull property="attributes">
				<isNotEqual property="attributes" compareValue="">
					attributes = TO_JSON(#attributes#::json),
				</isNotEqual>
			</isNotNull>
			<isNotNull property="description">
				<isNotEqual property="description" compareValue="">
					description = #description#,
				</isNotEqual>
			</isNotNull>
			update_date = now()
		WHERE data_id = #data_id#
	</update>

	<!-- Data 삭제 -->
	<delete id="EgovDataDAO.deleteData" parameterClass="long">
		/* deleteData */
		DELETE FROM data_info WHERE data_id = #data_id#
	</delete>
	
</sqlMap> 